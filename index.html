<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unlock Focus Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 font-sans">
  <div class="max-w-3xl mx-auto px-6 py-12 space-y-8">
    <header class="text-center space-y-2">
      <h1 class="text-3xl font-bold text-slate-900">Unlock Focus Mode</h1>
      <p class="text-slate-600">Connect your phone to enable the app.</p>
    </header>
    <div class="bg-white p-8 rounded-2xl shadow-sm ring-1 ring-slate-200 text-center space-y-6">
      <button id="connectBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-all disabled:opacity-50">
        Connect Android Device
      </button>
      <div class="text-left space-y-2">
        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status Log</label>
        <div id="console" class="bg-slate-900 text-green-400 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto leading-relaxed"></div>
      </div>
    </div>
    <div class="text-center text-sm text-slate-500 space-y-2 mt-4">
      <p>‚ö†Ô∏è Make sure USB debugging is enabled on your device</p>
      <p>üí° Accept the USB debugging prompt on your phone</p>
      <p>üîß If it fails, run <code class="bg-slate-200 px-2 py-1 rounded">adb kill-server</code> in terminal</p>
    </div>
  </div>
  
  <!-- Use Skypack for proper ESM resolution -->
  <script type="importmap">
  {
    "imports": {
      "@yume-chan/adb": "https://cdn.skypack.dev/@yume-chan/adb@0.0.24",
      "@yume-chan/adb-daemon-webusb": "https://cdn.skypack.dev/@yume-chan/adb-daemon-webusb@0.0.24",
      "@yume-chan/stream-extra": "https://cdn.skypack.dev/@yume-chan/stream-extra@0.0.24",
      "@yume-chan/struct": "https://cdn.skypack.dev/@yume-chan/struct@0.0.24",
      "@yume-chan/event": "https://cdn.skypack.dev/@yume-chan/event@0.0.24"
    }
  }
  </script>
  
  <script type="module">
    import { AdbDaemonWebUsbDeviceManager } from "@yume-chan/adb-daemon-webusb";
    import { AdbDaemonTransport, Adb } from "@yume-chan/adb";
    
    // --- CONFIG ---
    const PACKAGE_NAME = "com.example.muse"; 
    const PERMISSION = "android.permission.WRITE_SECURE_SETTINGS";
    const CMD = `pm grant ${PACKAGE_NAME} ${PERMISSION}`;
    
    const consoleDiv = document.getElementById("console");
    const connectBtn = document.getElementById("connectBtn");
    
    const log = (msg, isError = false) => {
      const div = document.createElement("div");
      div.textContent = `> ${msg}`;
      if (isError) div.style.color = "#ff6b6b";
      consoleDiv.appendChild(div);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };
    
    if (!navigator.usb) {
      log("Error: WebUSB not supported. Use Chrome or Edge.", true);
      connectBtn.disabled = true;
    } else {
      log("System Ready. Click Connect.");
    }
    
    // RSA key generation for ADB authentication
    async function generateRSAKey() {
      try {
        const keyPair = await crypto.subtle.generateKey(
          {
            name: "RSASSA-PKCS1-v1_5",
            modulusLength: 2048,
            publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
            hash: { name: "SHA-1" }
          },
          true,
          ["sign", "verify"]
        );
        return keyPair;
      } catch (err) {
        log(`Key generation error: ${err.message}`, true);
        throw err;
      }
    }
    
    connectBtn.onclick = async () => {
      let adb = null;
      try {
        log("Opening device picker...");
        connectBtn.disabled = true;
        
        const manager = AdbDaemonWebUsbDeviceManager.BROWSER;
        const device = await manager.requestDevice();
        
        if (!device) {
          log("No device selected.");
          connectBtn.disabled = false;
          return;
        }
        
        log(`Device: ${device.serial}`);
        log("Connecting to device...");
        
        const connection = await device.connect();
        log("Connection established");
        log("Generating authentication keys...");
        
        const keyPair = await generateRSAKey();
        
        const credentialStore = {
          async *iterateKeys() {
            yield keyPair;
          },
          async generateKey() {
            return keyPair;
          }
        };
        
        log("Authenticating with device...");
        log("(Check your phone for USB debugging prompt)");
        
        const transport = await AdbDaemonTransport.authenticate({
          serial: device.serial,
          connection,
          credentialStore
        });
        
        adb = new Adb(transport);
        log("‚úì Authentication successful!");
        log("---------------------------");
        log(`Executing: ${CMD}`);
        
        const output = await adb.subprocess.spawnAndWaitLegacy(CMD);
        
        log("---------------------------");
        if (output && output.trim()) {
          log(`Output: ${output.trim()}`);
        } else {
          log("Command executed successfully (no output)");
        }
        log("---------------------------");
        log("‚úì SUCCESS! Permission granted.", false);
        log("‚úì You can now disconnect your device.", false);
        
        alert("‚úì Success! Permission granted.\n\nYou can now disconnect your device and use your app.");
        
      } catch (err) {
        console.error("Full error:", err);
        
        if (err.name === "NotFoundError") {
          log("Device selection cancelled.", false);
        } else if (err.message?.includes("claim") || err.message?.includes("interface")) {
          log("ERROR: Device interface busy!", true);
          log("Fix: Run 'adb kill-server' in terminal and reconnect device.", true);
        } else if (err.message?.includes("undefined") || err.message?.includes("properties")) {
          log("ERROR: Authentication/protocol issue", true);
          log("Possible causes:", false);
          log("1. USB debugging not authorized on phone", false);
          log("2. ADB server interference - run 'adb kill-server'", false);
          log("3. Try disconnecting and reconnecting device", false);
        } else {
          log(`ERROR: ${err.message || String(err)}`, true);
        }
      } finally {
        if (adb) {
          try {
            await adb.close();
            log("Connection closed.");
          } catch (e) {
            // Ignore close errors
          }
        }
        connectBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
