<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlock Focus Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script type="importmap">
  {
    "scopes": {
      "https://ga.jspm.io/": {
        "buffer": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/buffer.js",
        "process": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/process.js"
      }
    },
    "imports": {
      "@yume-chan/adb": "https://ga.jspm.io/npm:@yume-chan/adb@2.1.3/index.js",
      "@yume-chan/adb-daemon-webusb": "https://ga.jspm.io/npm:@yume-chan/adb-daemon-webusb@2.1.3/index.js",
      "@yume-chan/adb-credential-web": "https://ga.jspm.io/npm:@yume-chan/adb-credential-web@2.1.3/index.js",
      "@yume-chan/adb-transport": "https://ga.jspm.io/npm:@yume-chan/adb-transport@2.1.3/index.js",
      "h3": "https://ga.jspm.io/npm:h3@1.11.1/dist/index.mjs"
    }
  }
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 font-sans">

  <div class="max-w-3xl mx-auto px-6 py-12 space-y-8">
    <header class="text-center space-y-2">
      <h1 class="text-3xl font-bold text-slate-900">Unlock Focus Mode</h1>
      <p class="text-slate-600">Connect your phone to enable the app.</p>
    </header>

    <div class="bg-white p-8 rounded-2xl shadow-sm ring-1 ring-slate-200 text-center space-y-6">
      <button id="connectBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
        Connect Android Device
      </button>

      <div class="text-left space-y-2">
        <div class="flex justify-between items-end">
          <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Console Log</label>
          <button id="clearBtn" class="text-xs text-blue-500 hover:underline">Clear</button>
        </div>
        <div id="console" class="bg-slate-900 text-green-400 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto leading-relaxed"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- 1. IMPORTS ---
    import { Adb } from "@yume-chan/adb";
    import { AdbDaemonTransport } from "@yume-chan/adb-transport";
    import { AdbDaemonWebUsbDeviceManager } from "@yume-chan/adb-daemon-webusb";
    import AdbWebCredentialStore from "@yume-chan/adb-credential-web";

    // --- 2. CONFIG ---
    const PACKAGE_NAME = "com.example.muse"; // <--- MAKE SURE THIS MATCHES!
    const PERMISSION = "android.permission.WRITE_SECURE_SETTINGS";
    
    // --- 3. LOGGING ---
    const consoleDiv = document.getElementById("console");
    const log = (msg, isError = false) => {
      const div = document.createElement("div");
      div.textContent = `> ${msg}`;
      if(isError) div.style.color = "#ff6b6b";
      consoleDiv.appendChild(div);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };
    document.getElementById("clearBtn").onclick = () => consoleDiv.innerHTML = "";

    // --- 4. TEXT DECODER ---
    const decoder = new TextDecoder();

    // --- 5. MAIN LOGIC ---
    document.getElementById("connectBtn").onclick = async () => {
      try {
        log("Looking for USB devices...");
        
        // 1. Get Manager
        const Manager = AdbDaemonWebUsbDeviceManager.BROWSER;
        if (!Manager) throw new Error("WebUSB not supported. Use Chrome/Edge.");

        // 2. Request Device
        const device = await Manager.requestDevice();
        if (!device) {
          log("No device selected.", true);
          return;
        }

        log(`Connecting to ${device.name}...`);
        const connection = await device.connect();

        log("Authenticating... (Please tap ALLOW on your phone)");
        const credentialStore = new AdbWebCredentialStore();
        
        // 3. Authenticate
        const transport = await AdbDaemonTransport.authenticate({
          serial: device.serial,
          connection,
          credentialStore,
        });

        // 4. Create ADB Instance
        const adb = new Adb(transport);

        log("Authorized! Sending command...");
        
        // 5. Execute Command (Standard API)
        const process = await adb.subprocess.spawn(`pm grant ${PACKAGE_NAME} ${PERMISSION}`);
        
        // 6. Read Output (Important to drain the stream)
        const reader = process.stdout.getReader();
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          log(decoder.decode(value));
        }

        log("-----------------------------------");
        log("SUCCESS! Permission granted.", false);
        log("You can unplug your phone now.", false);
        alert("Success! App unlocked.");

      } catch (err) {
        console.error(err);
        if(err.message.includes("ClaimInterface")) {
            log("ERROR: Device is busy. Run `adb kill-server` in terminal.", true);
        } else {
            log(`ERROR: ${err.message}`, true);
        }
      }
    };
  </script>
</body>
</html>
