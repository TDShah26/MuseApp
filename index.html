<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlock Focus Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script type="importmap">
  {
    "imports": {
      "@yume-chan/adb": "https://esm.sh/@yume-chan/adb@2.3.1?bundle",
      "@yume-chan/adb-daemon-webusb": "https://esm.sh/@yume-chan/adb-daemon-webusb@2.1.0?bundle",
      "@yume-chan/adb-credential-web": "https://esm.sh/@yume-chan/adb-credential-web@2.1.0?bundle"
    }
  }
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 font-sans">

  <div class="max-w-3xl mx-auto px-6 py-12 space-y-8">
    <header class="text-center space-y-2">
      <h1 class="text-3xl font-bold text-slate-900">Unlock Focus Mode</h1>
      <p class="text-slate-600">Connect your phone to enable the app.</p>
    </header>

    <div id="protocolWarning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md">
      <p class="font-bold">⚠️ CRITICAL ERROR: File Opened Incorrectly</p>
      <p>You cannot double-click this file. You must run it on a local server.</p>
      <p class="mt-2 text-sm">VS Code users: Right-click -> "Open with Live Server".</p>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm ring-1 ring-slate-200 text-center space-y-6">
      <button id="connectBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
        Connect Android Device
      </button>

      <div class="text-left space-y-2">
        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Console Log</label>
        <div id="console" class="bg-slate-900 text-green-400 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto leading-relaxed"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- 1. IMPORTS (Now clean thanks to Import Map) ---
    import { Adb, AdbDaemonTransport } from "@yume-chan/adb";
    import { AdbDaemonWebUsbDeviceManager } from "@yume-chan/adb-daemon-webusb";
    import AdbWebCredentialStore from "@yume-chan/adb-credential-web";

    // --- 2. CONFIG ---
    const PACKAGE_NAME = "com.example.muse"; // <--- CHANGE THIS!
    const PERMISSION = "android.permission.WRITE_SECURE_SETTINGS";
    
    // --- 3. LOGGING UTILS ---
    const consoleDiv = document.getElementById("console");
    const log = (msg, isError = false) => {
      const div = document.createElement("div");
      div.textContent = `> ${msg}`;
      if(isError) div.style.color = "#ff6b6b";
      consoleDiv.appendChild(div);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };

    // --- 4. SERVER CHECK ---
    if (window.location.protocol === 'file:') {
        document.getElementById("protocolWarning").classList.remove("hidden");
        document.getElementById("connectBtn").disabled = true;
        log("ERROR: You opened this as a file. Please use a Local Server (localhost).", true);
        throw new Error("File protocol detected");
    }

    log("System initialized. Ready to connect.");

    // --- 5. MAIN LOGIC ---
    document.getElementById("connectBtn").onclick = async () => {
      try {
        log("Looking for USB devices...");
        
        const Manager = AdbDaemonWebUsbDeviceManager.BROWSER;
        if (!Manager) throw new Error("WebUSB not supported in this browser (Use Chrome).");

        const device = await Manager.requestDevice();
        if (!device) {
          log("No device selected.", true);
          return;
        }

        log(`Connecting to ${device.name}...`);
        const connection = await device.connect();

        log("Authenticating... (Please tap ALLOW on your phone screen)");
        const credentialStore = new AdbWebCredentialStore();
        const transport = await AdbDaemonTransport.authenticate({
          serial: device.serial,
          connection,
          credentialStore,
        });

        log("Authorized! Sending command...");
        const adb = new Adb(transport);
        
        // Execute Command
        const process = await adb.subprocess.spawn(`pm grant ${PACKAGE_NAME} ${PERMISSION}`);
        
        // Wait for it to finish
        await process.exit;
        
        log("SUCCESS! Permission granted.", false);
        log("You may now unplug your phone.");
        alert("Success! App unlocked.");

      } catch (err) {
        console.error(err);
        if(err.message.includes("ClaimInterface")) {
            log("ERROR: Device is busy. Close Android Studio/ADB.", true);
        } else {
            log(`ERROR: ${err.message}`, true);
        }
      }
    };
  </script>
</body>
</html>
