<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlock Focus Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 font-sans">

  <div class="max-w-3xl mx-auto px-6 py-12 space-y-8">
    <header class="text-center space-y-2">
      <h1 class="text-3xl font-bold text-slate-900">Unlock Focus Mode</h1>
      <p class="text-slate-600">Connect your phone to enable the app.</p>
    </header>

    <div class="bg-white p-8 rounded-2xl shadow-sm ring-1 ring-slate-200 text-center space-y-6">
      <button id="connectBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-all disabled:opacity-50">
        Connect Android Device
      </button>

      <div class="text-left space-y-2">
        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status Log</label>
        <div id="console" class="bg-slate-900 text-green-400 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto leading-relaxed"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // We use 'webadb.js' which is a single file. No complex imports.
    import Adb from "https://cdn.jsdelivr.net/gh/cyrus-and/webadb@master/webadb.js";

    // --- CONFIGURATION ---
    const PACKAGE_NAME = "com.example.muse"; // <--- CHANGE THIS to your App ID
    const PERMISSION = "android.permission.WRITE_SECURE_SETTINGS";
    const CMD = `pm grant ${PACKAGE_NAME} ${PERMISSION}`;

    const consoleDiv = document.getElementById("console");
    const connectBtn = document.getElementById("connectBtn");

    // Helper: Logging
    const log = (msg, isError = false) => {
      const div = document.createElement("div");
      div.textContent = `> ${msg}`;
      if (isError) div.style.color = "#ff6b6b";
      consoleDiv.appendChild(div);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };

    // Helper: Check Support
    if (!navigator.usb) {
      log("Error: WebUSB not supported. Use Chrome or Edge.", true);
      connectBtn.disabled = true;
    } else {
      log("System Ready. Click Connect.");
    }

    // Main Logic
    connectBtn.onclick = async () => {
      try {
        log("Opening device picker...");
        
        // 1. Open Connection
        const adb = await Adb.open("WebUSB");
        if (!adb) {
             log("No device selected.", true);
             return;
        }
        
        log("Device connected. Authenticating...");
        
        // 2. Connect (Matches the library API)
        await adb.connect();
        
        log("Sending command...");
        log(`Executing: ${CMD}`);

        // 3. Run Command (Simpler API)
        const shell = await adb.shell(CMD);
        const output = await shell.receive();

        log("Response: " + output);
        log("---------------------------");
        log("SUCCESS! Permission granted.", false);
        log("You can unplug your phone now.", false);
        alert("Success! App unlocked.");

      } catch (err) {
        console.error(err);
        if (err.message && err.message.includes("claimInterface")) {
          log("ERROR: Device busy! Run `adb kill-server` in terminal.", true);
        } else {
          log(`ERROR: ${err.message || err}`, true);
        }
      }
    };
  </script>
</body>
</html>
